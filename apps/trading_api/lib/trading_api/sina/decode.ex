defmodule TradingApi.Sina.Decode do
  @javascript "var xh5_S_KLC_D=function(t){var e,n,i,r,o,a,s,l=86400000,c=7657,u=[],h=[],d=~(3<<30),f=1<<30,p=[0,3,5,6,9,10,12,15,17,18,20,23,24,27,29,30],g=Math,v=function(){var l,c;for(l=0;64>l;l++){h[l]=g.pow(2,l),26>l&&(u[l]=m(l+65),u[l+26]=m(l+97),10>l&&(u[l+52]=m(l+48)))}for(u.push('+','/'),u=u.join(''),n=t.split(''),i=n.length,l=0;i>l;l++){n[l]=u.indexOf(n[l])}return r={},e=a=0,o={},c=w([12,6]),s=63^c[1],{_1479:C,_136:T,_200:A,_139:k,_197:_}['_'+c[0]]||function(){return[]}},m=String.fromCharCode,b=function(t){return t==={}._},y=function(){var t,e;for(t=x(),e=1;;){if(!x()){return e*(2*t-1)}e++}},x=function(){var t;return e>=i?0:(t=n[e]&1<<a,a++,a>=6&&(a-=6,e++),!!t)},w=function(t,r,o){var s,l,c,u,d;for(l=[],c=0,r||(r=[]),o||(o=[]),s=0;s<t.length;s++){if(u=t[s],c=0,u){if(e>=i){return l}if(t[s]<=0){c=0}else{if(t[s]<=30){for(;d=6-a,d=u>d?d:u,c|=(n[e]>>a&(1<<d)-1)<<t[s]-u,a+=d,a>=6&&(a-=6,e++),u-=d,!(0>=u);){}r[s]&&c>=h[t[s]-1]&&(c-=h[t[s]])}else{c=w([30,t[s]-30],[0,r[s]]),o[s]||(c=c[0]+c[1]*h[30])}}l[s]=c}else{l[s]=0}}return l},N=function(t){var e,n,i,o;for(t>1&&(e=0),e=0;t>e;e++){r.d++,i=r.d%7,(3==i||4==i)&&(r.d+=5-i)}return n=new Date,o=60*n.getTimezoneOffset()*1000,n.setTime((c+r.d)*l+o),n.setHours(n.getHours()+8),n},A=function(){var t,n,o,a,l;if(s>=1){return[]}for(r.d=w([18],[1])[0]-1,o=w([3,3,30,6]),r.p=o[0],r.ld=o[1],r.cd=o[2],r.c=o[3],r.m=g.pow(10,r.p),r.pc=r.cd/r.m,n=[],t=0;a={d:1},x()&&(o=w([3])[0],0==o?a.d=w([6])[0]:1==o?(r.d=w([18])[0],a.d=0):a.d=o),l={date:N(a.d)},x()&&(r.ld+=y()),o=w([3*r.ld],[1]),r.cd+=o[0],l.close=r.cd/r.m,n.push(l),!(e>=i)&&(e!=i-1||63&(r.c^t+1));t++){}return n[0].prevclose=r.pc,n},T=function(){var t,n,o,a,l,c,u,h,d,f,p;if(s>=2){return[]}for(u=[],d={v:'volume',p:'price',a:'avg_price'},r.d=w([18],[1])[0]-1,h={date:N(1)},o=w(1>s?[3,3,4,1,1,1,5]:[4,4,4,1,1,1,3]),t=0;7>t;t++){r[['la','lp','lv','tv','rv','zv','pp'][t]]=o[t]}for(r.m=g.pow(10,r.pp),s>=1?(o=w([3,3]),r.c=o[0],o=o[1]):(o=5,r.c=2),r.pc=w([6*o])[0],h.pc=r.pc/r.m,r.cp=r.pc,r.da=0,r.sa=r.sv=0,t=0;!(e>=i)&&(e!=i-1||7&(r.c^t));t++){for(l={},a={},f=r.tv?x():1,n=0;3>n;n++){if(p=['v','p','a'][n],(f?x():0)&&(o=y(),r['l'+p]+=o),c='v'==p&&r.rv?x():1,o=w([3*r['l'+p]+('v'==p?7*c:0)],[!!n])[0]*(c?1:100),a[p]=o,'v'==p){if(!(l[d[p]]=o)&&241>t&&(r.zv?!x():1)){a.p=0;break}}else{'a'==p&&(r.da=(1>s?0:r.da)+a.a)}}r.sv+=a.v,l[d.p]=(r.cp+=a.p)/r.m,r.sa+=a.v*r.cp,l[d.a]=b(a.a)?t?u[t-1][d.a]:l[d.p]:r.sv?((g.floor((r.sa*(2000/r.m)+r.sv)/r.sv)>>1)+r.da)/1000:l[d.p]+r.da/1000,u.push(l)}return u[0].date=h.date,u[0].prevclose=h.pc,u},C=function(){var t,e,n,i,o,a,l;if(s>=1){return[]}for(r.lv=0,r.ld=0,r.cd=0,r.cv=[0,0],r.p=w([6])[0],r.d=w([18],[1])[0]-1,r.m=g.pow(10,r.p),o=w([3,3]),r.md=o[0],r.mv=o[1],t=[];o=w([6]),o.length;){if(n={c:o[0]},i={},n.d=1,32&n.c){for(;;){if(o=w([6])[0],63==(16|o)){l=16&o?'x':'u',o=w([3,3]),n[l+'_d']=o[0]+r.md,n[l+'_v']=o[1]+r.mv;break}if(32&o){a=8&o?'d':'v',l=16&o?'x':'u',n[l+'_'+a]=(7&o)+r['m'+a];break}if(a=15&o,0==a?n.d=w([6])[0]:1==a?(r.d=a=w([18])[0],n.d=0):n.d=a,!(16&o)){break}}}i.date=N(n.d);for(a in {v:0,d:0}){b(n['x_'+a])||(r['l'+a]=n['x_'+a]),b(n['u_'+a])&&(n['u_'+a]=r['l'+a])}for(n.l_l=[n.u_d,n.u_d,n.u_d,n.u_d,n.u_v],l=p[15&n.c],1&n.u_v&&(l=31-l),16&n.c&&(n.l_l[4]+=2),e=0;5>e;e++){l&1<<4-e&&n.l_l[e]++,n.l_l[e]*=3}n.d_v=w(n.l_l,[1,0,0,1,1],[0,0,0,0,1]),a=r.cd+n.d_v[0],i.open=a/r.m,i.high=(a+n.d_v[1])/r.m,i.low=(a-n.d_v[2])/r.m,i.close=(a+n.d_v[3])/r.m,o=n.d_v[4],'number'==typeof o&&(o=[o,o>=0?0:-1]),r.cd=a+n.d_v[3],l=r.cv[0]+o[0],r.cv=[l&d,r.cv[1]+o[1]+!!((r.cv[0]&d)+(o[0]&d)&f)],i.volume=(r.cv[0]&f-1)+r.cv[1]*f,t.push(i)}return t},k=function(){var t,e,n,i;if(s>1){return[]}for(r.l=0,i=-1,r.d=w([18])[0]-1,n=w([18])[0];r.d<n;){e=N(1),0>=i?(x()&&(r.l+=y()),i=w([3*r.l],[0])[0]+1,t||(t=[e],i--)):t.push(e),i--}return t},_=function(){var t,n,o,a;if(s>=1){return[]}for(r.f=w([6])[0],r.c=w([6])[0],o=[],r.dv=[],r.dl=[],t=0;t<r.f;t++){r.dv[t]=0,r.dl[t]=0}for(t=0;!(e>=i)&&(e!=i-1||7&(r.c^t));t++){for(a=[],n=0;n<r.f;n++){x()&&(r.dl[n]+=y()),r.dv[n]+=w([3*r.dl[n]],[1])[0],a[n]=r.dv[n]}o.push(a)}return o};return v()()};"

  def decode(data) do
    context = Execjs.compile(@javascript)
    Execjs.call(context, "xh5_S_KLC_D", [data])
  end
end